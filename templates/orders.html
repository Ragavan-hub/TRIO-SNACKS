{% extends "base.html" %}

{% block title %}Orders History - Trio Snacks{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>Orders History</h1>
        <div class="period-filters">
            <a href="{{ url_for('orders', period='today') }}" class="period-btn {% if period == 'today' %}active{% endif %}">Today</a>
            <a href="{{ url_for('orders', period='week') }}" class="period-btn {% if period == 'week' %}active{% endif %}">This Week</a>
            <a href="{{ url_for('orders', period='month') }}" class="period-btn {% if period == 'month' %}active{% endif %}">This Month</a>
            <a href="{{ url_for('orders', period='all') }}" class="period-btn {% if period == 'all' %}active{% endif %}">All</a>
        </div>
    </div>

    <div class="summary-cards">
        <div class="summary-card">
            <h3>Total Orders</h3>
            <p class="summary-value">{{ total_orders }}</p>
        </div>
        <div class="summary-card">
            <h3>Total Sales</h3>
            <p class="summary-value">₹{{ "%.2f"|format(total_sales) }}</p>
        </div>
    </div>

    <div class="orders-table-container">
        <table class="orders-table">
            <thead>
                <tr>
                    <th>Invoice #</th>
                    <th>Date & Time</th>
                    <th>Customer</th>
                    <th>Items</th>
                    <th>Total</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr>
                    <td>{{ order.invoice_number }}</td>
                    <td>{{ order.created_at.strftime('%d-%m-%Y %H:%M') }}</td>
                    <td>
                        {% if order.customer_name %}
                            {{ order.customer_name }}
                        {% else %}
                            <span class="text-muted">Walk-in</span>
                        {% endif %}
                    </td>
                    <td>{{ order.items|length }} items</td>
                    <td>₹{{ "%.2f"|format(order.total_amount) }}</td>
                    <td>
                        <a href="{{ url_for('order_detail', order_id=order.id) }}" class="btn btn-sm btn-primary">View</a>
                        <a href="{{ url_for('invoice_pdf', order_id=order.id) }}" class="btn btn-sm btn-secondary">PDF</a>
                        {% if session.role == 'admin' %}
                            <button class="btn btn-sm btn-danger" onclick="deleteOrder({{ order.id }})">Delete</button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if not orders %}
            <p class="no-orders">No orders found for the selected period.</p>
        {% endif %}
    </div>
</div>

<script>
function deleteOrder(orderId) {
    if (!confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/orders/${orderId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Order deleted successfully');
            location.reload();
        } else {
            alert('Error deleting order: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting order');
    });
}
</script>
{% endblock %}

